# Электронная/экранная лупа — конечные требования (PRD)

## 1. Цели продукта
- Обеспечить комфортную работу пользователя с двумя мониторами за счёт отдельного полноэкранного окна лупы на одном из мониторов и рабочего стола на другом.
- Сделать следование за текстовым курсором (каретом) и мышью предсказуемым, стабильным и настраиваемым, исключив рывки/«дрожание» изображения.
- Исключить мешающий интерфейс (панели/блоки), сохранив управление через трей и горячие клавиши.
- Обеспечить корректную работу при разных разрешениях и масштабах (DPI) мониторов.

## 2. Термины
- «Экран лупы» — монитор, на котором отображается полноэкранное окно лупы.
- «Рабочий экран» — монитор, на котором пользователь работает с приложениями.
- «Карет» — текстовый курсор ввода (мигающая вертикальная черта).
- «Текстовый блок/контрол» — область ввода текста (например, textarea/редактор), потенциально целиком помещающаяся в окно лупы.

## 3. Поддерживаемая платформа и ограничения
- ОС: Windows 10 x64 (19041/20H1 и новее).
- Видеоподсистема: GPU с поддержкой DirectX 11 (или эквивалент); требуется аппаратное ускорение.
- Мониторы: минимум 2; допускаются разные разрешения, ориентации и масштабы (Per‑Monitor DPI).
- Архитектура: 64‑битный исполняемый файл; portable (.exe) без обязательной установки.

## 4. Пользовательские сценарии (основные)
- Пользователь включает лупу на втором мониторе, управляет увеличением и режимом слежения горячими клавишами, без появления всплывающих панелей.
- При наборе текста лупа следует за каретом, удерживая карет в заданной области окна (например, 50%/50%).
- При перемещении мыши (в режиме слежения за мышью) изображение сдвигается плавно, игнорируя микродвижения (мертвая зона).
- Пользователь одной клавишей меняет местами мониторы «рабочий ↔ лупа».
- Пользователь временно обходит запрет на попадание курсора на экран лупы (быстрый обход), когда это необходимо.

## 5. Функциональные требования
### 5.1. Окно лупы
- Полноэкранное borderless окно на «экране лупы», поверх всех окон, без рамок и заголовков.
- Не отображается в Alt‑Tab; управление — через трей и горячие клавиши.
- Должно масштабировать изображение рабочего экрана согласно текущему уровню увеличения и правилам позиционирования (см. ниже).

### 5.2. Мониторы и их выбор
- Настройка «Источник» (какой экран увеличивается) и «Экран лупы» (где показывать лупу).
- Горячая клавиша «Поменять местами экраны» мгновенно меняет роли мониторов.
- Корректная работа при разных разрешениях и масштабах (пересчёт координат, сохранение пропорций).

### 5.3. Режимы слежения (переключаемые)
- Auto: при активном наборе текста — следование за каретом; при явных перемещениях мыши — следование за мышью. Гистерезис и задержки исключают частые переключения.
- Caret: следование только за каретом.
- Mouse: следование только за мышью.
- Focus: следование за фокусом UI‑элемента (если недоступен карет) как фолбэк.
- Manual: без слежения; управление положением области обзора стрелками/колёсиком.

### 5.4. Позиционирование «точки интереса» в окне лупы
- Отдельные настройки для карета и для мыши.
- Пресеты привязок: по вертикали — 25%/50%/75%; по горизонтали — 25%/50%/75%.
- Возможность задать произвольные проценты в настройках.
- Горячие клавиши для циклического переключения пресетов вертикально и горизонтально.
- Быстрая централизация (50%/50%) отдельной клавишей.

### 5.5. Масштабирование (зум)
- Диапазон: 100%…1600% с шагом 10% по горячим клавишам.
- Сброс к предустановленному значению (по умолчанию 300%).
- Переключаемый алгоритм масштабирования: «резкий» (по пикселям) и «плавный» (сглаживание).

### 5.6. Режим «Текстовый блок целиком» (опционально)
- Если текущий текстовый контрол (textarea/редактор) полностью помещается в окно лупы при заданном увеличении, можно одной клавишей вписать его целиком.
- Допускается временное превышение базового зума (до 1000%) для полного размещения (опция).
- Режим должен быть отключаемым и управляться отдельной горячей клавишей.

### 5.7. Стабилизация и анти‑дрожание
- «Мёртвая зона» для мыши (по умолчанию 8 px, настраиваемо), в пределах которой слежение не срабатывает.
- Плавная интерполяция/сглаживание перемещений зоны обзора.
- В Auto‑режиме во время набора текстов игнорировать микроперемещения мыши; переключение обратно на мышь — только после явного перемещения (за пределы мёртвой зоны) и/или по истечении настраиваемой задержки.

### 5.8. Ограничение курсора и окон на экране лупы
- Опция «Защитить экран лупы» (включаемая/выключаемая):
  - Ограничение курсора (ClipCursor) — запрет попадания мыши на экран лупы.
  - «App Guard» — автоматический перенос новых/активируемых окон, оказавшихся на экране лупы, на рабочий экран.
- Быстрый временный обход (bypass): удержание специальной горячей клавиши включает проход курсора на 5 секунд и приостанавливает перенос окон.
- Состояние и обход — доступны горячими клавишами и в меню трея.

### 5.9. Горячие клавиши (по умолчанию; переопределяемые)
- Все сочетания по умолчанию используют Win+Ctrl+Alt, чтобы избежать конфликтов с приложениями и системной лупой Windows.
- Увеличить/уменьшить зум: Win+Ctrl+Alt+`=` / Win+Ctrl+Alt+`-` (шаг 10%).
- Сбросить зум к базовому: Win+Ctrl+Alt+`0`.
- Поменять экраны местами: Win+Ctrl+Alt+`S`.
- Переключить режим слежения (Auto→Caret→Mouse→Focus→Manual): Win+Ctrl+Alt+`F`.
- Центрировать точку интереса: Win+Ctrl+Alt+`C`.
- Вертикальная привязка (25/50/75%): Win+Ctrl+Alt+`8`.
- Горизонтальная привязка (25/50/75%): Win+Ctrl+Alt+`9`.
- Режим «Текстовый блок целиком»: Win+Ctrl+Alt+`T`.
- Пауза слежения (вкл/выкл): Win+Ctrl+Alt+`P`.
- «Защитить экран лупы» (вкл/выкл): Win+Ctrl+Alt+`G`.
- Быстрый обход защиты (удержание на 5 сек): Win+Ctrl+Alt+`Q`.

### 5.10. Интерфейс и настройки
- Никаких всплывающих панелей на экране лупы.
- Только трей‑иконка и окно настроек, которое всегда открывается на рабочем экране.
- Первый запуск: краткий мастер выбора «экран лупы», базовый зум, режим слежения.
- Сохранение настроек в профиле пользователя; импорт/экспорт конфигурации.
- Опциональный автозапуск при входе в систему.

### 5.11. Совместимость и поведение в проблемных приложениях
- Слежение за каретом реализовано с каскадом методов; если карет недоступен (например, Telegram/старые инсталляторы), Auto‑режим использует фокус/мышь как фолбэк — без рывков.
- Предусмотреть «белые/чёрные списки» приложений для принудительного режима слежения (через настройки).

### 5.12. Диагностика и приватность
- Опциональный лог диагностики (вкл/выкл) для разбора проблем слежения; лог не содержит содержимого экрана, только события/координаты/метаданные.
- Никакой телеметрии и сетевой активности без явного согласия.

## 6. Нефункциональные требования
- Производительность и плавность:
  - Целевой FPS: 60 на разрешении 2560×1440; допускается адаптивное снижение до 45–60 при высоких нагрузках.
  - Средняя задержка отклика (от события до обновления экрана лупы): ≤ 50 мс при типичной нагрузке.
  - Нагрузка: целевой суммарный CPU ≤ 15% на современном 4–8‑ядерном CPU; GPU — без заметных просадок фреймтайма.
- DPI и масштаб:
  - Корректная работа при Per‑Monitor DPI (разный масштаб на мониторах), точные преобразования координат.
  - Сохранение пропорций изображения; опция «вписать»/«заполнить с обрезкой» при несоответствии аспектов.
- Надёжность:
  - Автовосстановление после изменения конфигурации дисплеев.
  - Корректная пауза на безопасных экранах (UAC, блокировка) — допустимо временное «замораживание» кадра или затемнение.
- Локализация: интерфейс по умолчанию на русском; поддержка английского (вторая очередь).

## 7. Конфликты и их разрешение (исключения)
- Не используется системная панель/блок управления лупой — отсутствует любой плавающий UI поверх экрана лупы.
- Горячие клавиши по умолчанию не конфликтуют с Windows Magnifier (избегаем Win+`+`/`-`/`Esc`). Полная переназначаемость доступна в настройках.
- «Запрет попадания курсора и окон на экран лупы» не является жёсткой политикой — это переключаемая опция с быстрым временным обходом.
- Не гарантируется 100% слежение за каретом во всех сторонних приложениях; заданы чёткие фолбэки и управляемые профили.

## 8. Критерии приёмки (проверяемые)
- Окно лупы полноэкранное, без рамок; отсутствует любой плавающий UI; управление через трей и горячие клавиши.
- Зум изменяется на 10% за шаг; диапазон 100–1600%; сброс к базовому работает.
- Пресеты привязок 25/50/75% переключаются горячими клавишами; центровка работает.
- Auto‑режим: в MS Word лупа уверенно следует за каретом, удерживая его в выбранной привязке; при лёгких дрожаниях мыши изображение стабильно.
- Telegram: при отсутствии событий карета лупа в Auto использует фокус/мышь, без рывков; ручное переключение режимов работает.
- Стабилизация: мёртвая зона по умолчанию устраняет «дрожание» при вибрации клавиатуры/мыши.
- Защита экрана лупы: при включении курсор не попадает на экран лупы, окна автоматически переносятся; быстрый обход по удержанию работает (5 сек).
- «Поменять экраны местами» — срабатывает мгновенно без артефактов.
- Разные разрешения/DPI: на конфигурации 2560×1440×2 с разными масштабами координаты и позиционирование корректны.
- Настройки горячих клавиш изменяемы; конфликтующие комбинации предупреждаются.

## 9. Поставляемые артефакты
- Portable .exe (x64), иконка в трее, окно настроек.
- Конфигурация пользователя в `%APPDATA%/ElectronicMagnifier/config.json` (или аналогичном каталоге).
- Краткая инструкция и список горячих клавиш.

## 10. Открытые опции (в будущих версиях)
- Профили настроек по приложениям (Word/Chromium/Telegram/Putty) с автопереключением.
- Дополнительные алгоритмы увеличения (шарпинг/суперрезолюшн) при больших зумах.
- Глобальная запись макросов/скриптов для управления лупой из сторонних приложений.
